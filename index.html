<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barcodes</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #barcodes > div { margin-bottom: 30px; }
  </style>
</head>
<body>
  <h1>Barcodes</h1>
  <div id="barcodes">Loading barcodes...</div>
  <button onclick="window.print()">Print</button>

  <script>
    async function loadJsBarcode() {
      if (!window.JsBarcode) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = "https://cdn.jsdelivr.net/jsbarcode/3.11.5/JsBarcode.all.min.js";
          script.onload = resolve;
          script.onerror = () => reject(new Error("Failed to load JsBarcode library"));
          document.head.appendChild(script);
        });
      }
    }

    async function fetchBarcodes() {
      const container = document.getElementById("barcodes");
      try {
        await loadJsBarcode();

        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        if (!id) {
          container.innerText = "Missing sales order ID in URL (e.g. ?id=5072431000005794116)";
          return;
        }

        const response = await fetch(`/api/salesorder?id=${id}`);
        if (!response.ok) throw new Error(`API error: ${response.status}`);

        const items = await response.json();
        container.innerHTML = "";

        if (!items.length) {
          container.innerText = "No barcodes found for this sales order.";
          return;
        }

        items.forEach(item => {
          const div = document.createElement("div");

          const name = document.createElement("div");
          name.innerText = `${item.name} (${item.sku})`;

          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          JsBarcode(svg, item.sku, { format: "CODE128", displayValue: true });

          div.appendChild(name);
          div.appendChild(svg);
          container.appendChild(div);
        });

      } catch (error) {
        container.innerText = "Error loading barcodes: " + error.message;
        console.error(error);
      }
    }

    window.onload = fetchBarcodes;
  </script>
</body>
</html>
