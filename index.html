<!DOCTYPE html>
<html>
<head>
  <title>Barcodes</title>
  <script src="https://cdn.jsdelivr.net/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <style>
    @media print {
      body {
        margin: 0;
      }
      .barcode-page {
        page-break-after: always;
        width: 3in;
        height: 4in;
        padding: 0.5in;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        text-align: center;
        position: relative;
      }
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0.5em;
    }
    .barcode-page {
      width: 3in;
      height: 4in;
      padding: 0.5in;
      box-sizing: border-box;
      border: 1px solid #ccc;
      margin-bottom: 1em;
      text-align: center;
      position: relative;
    }
    .logo {
      max-height: 40px;
      margin-bottom: 8px;
    }
    .customer-name, .order-number {
      font-weight: bold;
      margin: 4px 0;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-name {
      margin-top: 8px;
      font-size: 0.8rem;
      height: 2em;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <h1>Barcodes</h1>
  <div id="barcodes"></div>

  <button onclick="window.print()">Print Barcodes</button>

  <script>
    const logoUrl = 'https://rvacabinetry.com/images/RVA_Cabinetry.webp';

    // Helper to truncate long text
    function truncate(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.slice(0, maxLength - 3) + '...' : text;
    }

    async function fetchBarcodes() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      const customer = params.get("customer") || 'Unknown Customer';
      const order = params.get("order") || 'Unknown Order';

      if (!id) {
        document.getElementById('barcodes').innerText = "Missing sales order ID in URL.";
        return;
      }

      try {
        const response = await fetch(`/api/salesorder?id=${id}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const items = await response.json();

        if (!Array.isArray(items) || items.length === 0) {
          document.getElementById('barcodes').innerText = "No items found for this sales order.";
          return;
        }

        const container = document.getElementById("barcodes");
        container.innerHTML = '';

        items.forEach(item => {
          // Expect item.qty (number of items), default to 1 if missing or invalid
          const qty = (item.qty && item.qty > 0) ? item.qty : 1;

          for(let i=0; i < qty; i++) {
            const page = document.createElement("div");
            page.classList.add("barcode-page");

            // Logo
            const logo = document.createElement("img");
            logo.src = logoUrl;
            logo.alt = "Logo";
            logo.className = "logo";
            page.appendChild(logo);

            // Customer and order info
            const custDiv = document.createElement("div");
            custDiv.className = "customer-name";
            custDiv.textContent = customer;
            page.appendChild(custDiv);

            const orderDiv = document.createElement("div");
            orderDiv.className = "order-number";
            orderDiv.textContent = order;
            page.appendChild(orderDiv);

            // Product name
            const productName = document.createElement("div");
            productName.className = "product-name";
            productName.textContent = truncate(item.name, 30);
            page.appendChild(productName);

            // Barcode SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

            // Adjust barcode width & font size if SKU is long
            let width = 2;
            let fontSize = 14;
            if (item.sku.length > 15) {
              width = 1.2;
              fontSize = 10;
            }

            JsBarcode(svg, item.sku, {
              format: "CODE128",
              displayValue: true,
              fontSize: fontSize,
              width: width,
              height: 80,
              margin: 10,
              textMargin: 0
            });

            page.appendChild(svg);

            container.appendChild(page);
          }
        });
      } catch (err) {
        document.getElementById('barcodes').innerText = "Error loading barcodes: " + err.message;
      }
    }

    window.onload = fetchBarcodes;
  </script>
</body>
</html>
